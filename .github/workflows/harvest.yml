name: ğŸš€ Clarity Daily Harvester

on:
  schedule:
    # Runs at 23:00 UTC every day (= 00:00 CET+1)
    - cron: '0 23 * * *'
  
  # Also allow manual trigger from Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  harvest:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout code
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      # Setup Python
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Run harvester
      - name: ğŸŒ Run Clarity Harvester
        run: python harvester.py
      
      # Configure Git
      - name: ğŸ”§ Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
      
      # Commit changes
      - name: ğŸ’¾ Commit & Push changes
        run: |
          if [[ $(git status --porcelain) ]]; then
            git add data/ projects.csv
            git commit -m "ğŸ¤– Daily harvest: $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          else
            echo "No changes to commit"
          fi
      
      # Notify on failure
      - name: ğŸ“§ Notify on failure
        if: failure()
        run: |
          echo "âŒ Clarity Harvester failed!"
          echo "Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # Optional: Create a summary comment
  summary:
    needs: harvest
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Job Summary
        run: |
          echo "âœ… Clarity Harvester Workflow Completed"
          echo "- Run Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "- Status: ${{ job.status }}"
